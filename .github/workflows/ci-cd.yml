name: CI/CD Pipeline to Cloud Run

on:
  push:
    branches:
      - main

jobs:
  setup-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Setup GCP Cloud SDK
        uses: google-github-actions/setup-gcloud@master
        with:
          version: '290.0.0'
          service_account_key: ${{ secrets.ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiYWRlcHQtbW91bnRhaW4tNDE2ODE3IiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiZGJkMzU0Yjg1MGNhZjc0Y2U1YTZhNzUxZWI3NGM3MGQ4OWYzZGY5ZSIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZnSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2d3Z2dTa0FnRUFBb0lCQVFDNjhXZ3BibUpueFIrNlxuelhwN3J6Z2lxQURJYWI1OXhpMHViYzlUQ1ZCeGY5WXNzUU54WSt2YVkwbE1IOFg1TVJib0RGcVFpV1J4MisveFxuckpBSU1qeEtRY2Jvb3pRL2o4S095NmdaLzVobm1sVDRKOUxIR1dWdTFlMVJteWtrUGtsaTNQUnlNbmZZbWc2NFxuWllDQXY2b2FqZlNsMFY2YitpbkNyMDYwcmgvMDJWeEkyYTJ2cEVDazNlVXIxbXBENUhDT2NyNENpVVA4RlRtdVxuUDJDSDZPWktxWENUc0VRUzFPWkpoTEZ4YmhlTVlnQVZ0UWVSd3BVaTdZV0F2OFN4M0R0eVJ6L1FJQkcrdG9rSFxuS0tHYWZkTXJMSDlDQytlUitwQWUwMDdRMUVCM004Z1N4S0lDandMZDN4WlBFVjRGQUo5eUI0NU53RTlJMFBoRVxuaitIM3VUdVZBZ01CQUFFQ2dnRUFBcm52b3dhODNESExFZm4zeVl6b2pKZzVRWGZuZW5HaWNWdElkamZ2M1JhblxuQ0VVMDZaSUs4ZER3WjdiMHdhSkphTmxsNDMzam5PTlN4ODhlWHp5SlBWTVMzaFhWRkR3NTgwM0p6K1FzNTlMUVxuNkxqMU1BMWY2dkFkY2Z3Nm5GODl0a2hrQis4K2ZLamg1UCtmTCtqZ2xtNW1LL3lZMThjdnFTL2h4N3UxSUY3QlxuUyt1QnJsYnBOUHpTRjA5NXlmQytYbjhpMXRTYitXYmJIRnZyaFcxVUhKM0tncnc2bVhqYWFBRkRXREJLU0xnblxuYUFpaFpOOHB1WWJrSlloRmtrMzNTZFVDQTNsbUlUMlEvMHkxU08xRzZzUWtyejB4MjZYbTZ5N2N0VTJ5NEE3OFxuWVJUd0ZnM2VmaTlia0d6SW5GV2hicjdselpxUnY5elJsalQvUWF3VllRS0JnUUQvblIxeEo1K2VVaGdWZ3JUQVxuN1p1V1hrdGV6L0xGREU5RVRHRW9sdnVPakZKQzQySHBQOWliVVlybGg5OGhJampzUGhDMU1GaHJpdHVZMkIwMlxucmJJL2duYjhka21mbjB5MVFPQ3k4NmFwaEtpWTREaHFJVnMyN25McVVnRi9mak1YVmtxV2hCU1JtSCt3TW5zYVxuNkFkZmFlWkFieWxBVXk2V2RWTlU0T3dnVFFLQmdRQzdPYm4wRER6aE81WVNkclR6Wmd4Rzg3dDJrakV5N1VqV1xuOUhta29xSGtaZ254VXNZSXNpQUlFTVNneFYrU1BNR2lYb0RaOWtxZmwzT25CMWM5eG84M09lMkZOeGV1RFYwU1xuWE81Z1ppalF3VDRaQnNVVktuZzI3RWRKQnhHcnEvWTFvZEFxRFNaV0QwbDJIZm91SUszeHlBdjZCYzFROExPN1xuekp1VEVmM3NhUUtCZ1FDRHBvNDFhMjBBZzlPM3NId2NLY1RLcTRJeU1QUWVuUHB1ZU5CSnNZbWFuNWIyc0ZvTFxuWWtEVHJpblZraWRQejJwMThubDBlSlB4djdEZWhlQjErdndsVGJLdTBOV1dpdHRkTnk4RHZBNEluVFNnbUVzMlxuRGp3R2pNVk8vakdiVW9wSjZMMjl6QVV6LzlFMEZLdm03YjV1WEFLbENSdTc3NXU5RG14KytPRmt1UUtCZ0dZTlxubWtIZjVkTnowbUt3R0FSUWpNS2tHbndRUmdjWGRrdk5LUDFIdE8wMWZaZndZWWZkNkQzZFBnRFFkVDdXSlVvblxuTHg4ZjlCODN3OCs0M2FJTHVJY0c2V1JpMm1LQ1lFZ2hKY0tnRFFGMVJDOEtGS1ZyNStrd004OG5ya2NnVGUyQVxuRFdMT2xpWDA0VHNrTGZtMDBIdnBhalhYc2NtNzJveTBnOXpQd3RSNUFvR0JBS3BHVTArdTJRbmd6MWlDZWF5alxuR0psK1JzcVI5OGZPcmh1SVNZZWk5MEh3QlFCNGVTdkZGWENvMzdNeENWNFB6TlhaeFBTaTFpbitXRlpTazJ0R1xuTWlKVFRWeFhiRGVFQzliTnVVcGtteXRyYnhGR2V5M0dKVlZvYms5UmIwWWdzWUtObENqVllzMEcyWHJ6MUJQNlxuSFdOYWNVM2Fxbmw2Z25aNW5mbm1Xb1hlXG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAicHktY2RjZEBhZGVwdC1tb3VudGFpbi00MTY4MTcuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTEwMzYwODIwMzcyODI3NjYyMTg4IiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9weS1jZGNkJTQwYWRlcHQtbW91bnRhaW4tNDE2ODE3LmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAidW5pdmVyc2VfZG9tYWluIjogImdvb2dsZWFwaXMuY29tIgp9Cg== }}
          project_id: ${{ secrets.adept-mountain-416817 }}
          export_default_credentials: true

      - name: Build and Push Docker image
        run: |
          gcloud builds submit --tag gcr.io/${{ secrets.adept-mountain-416817 }}/fastapi-app:$GITHUB_SHA

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy fastapi-app --image gcr.io/${{ secrets.adept-mountain-416817 }}/fastapi-app:$GITHUB_SHA --platform managed --region your-region --allow-unauthenticated
